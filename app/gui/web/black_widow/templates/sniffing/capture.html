{% extends 'layout/base.html' %}
{% comment %}
<!--
*********************************************************************************
*                                                                               *
* capture.html -- HTML file.                                                    *
*                                                                               *
************ IMPORTANT MATERIAL DASHBOARD DARK EDITION LICENSE TERMS ************
*                                                                               *
* =========================================================                     *
* Material Dashboard Dark Edition - v2.1.0                                      *
* =========================================================                     *
*                                                                               *
* Product Page: https://www.creative-tim.com/product/material-dashboard-dark    *
* Copyright 2019 Creative Tim (http://www.creative-tim.com)                     *
*                                                                               *
* Coded by www.creative-tim.com                                                 *
*                                                                               *
* =========================================================                     *
*                                                                               *
* The above copyright notice and this permission notice shall be included in    *
* all copies or substantial portions of the Software.                           *
*                                                                               *
********************** IMPORTANT BLACK-WIDOW LICENSE TERMS **********************
*                                                                               *
* This file is part of black-widow.                                             *
*                                                                               *
* black-widow is free software: you can redistribute it and/or modify           *
* it under the terms of the GNU General Public License as published by          *
* the Free Software Foundation, either version 3 of the License, or             *
* (at your option) any later version.                                           *
*                                                                               *
* black-widow is distributed in the hope that it will be useful,                *
* but WITHOUT ANY WARRANTY; without even the implied warranty of                *
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                 *
* GNU General Public License for more details.                                  *
*                                                                               *
* You should have received a copy of the GNU General Public License             *
* along with black-widow.  If not, see <http://www.gnu.org/licenses/>.          *
*                                                                               *
*********************************************************************************
-->
{% endcomment %}
{% load static %}

{% block style %}
    <link href="{% static 'css/plugins/simplePagination.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
    {% csrf_token %}
    <!-- TODO: UI to view the packet captured. Features:
            - Show real-time traffic
            - Sorting/Search filters
            - Play/Pause/Reset/Stop
            - Download ".pcap" file
            -
    -->
    <div class="row">
        <div class="col-md-12">
            <div class="card card-plain">
                <div class="card-header card-header-primary">
                    <h4 class="card-title mt-0"> Network Traffic</h4>
                    <p class="card-category">
                        Here is the monitored traffic
                    </p>

                    <button id="play-capture-btn" type="button" class="btn btn-warning btn-action disabled" title="Play"
                            style="display: none">
                        <i class="material-icons" style="padding: 0;">play_arrow</i>
                    </button>

                    <button id="pause-capture-btn" type="button" class="btn btn-warning btn-action" title="Pause">
                        <i class="material-icons" style="padding: 0;">pause</i>
                    </button>

                    <button id="stop-capture-btn" type="button" class="btn btn-danger btn-action" title="Stop">
                        <i class="material-icons" style="padding: 0;">stop</i>
                    </button>

                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-select" id="sniffed-pkts-table">
                            <thead class="">
                            <tr>
                                <th>
                                    No.
                                </th>
                                <th>
                                    Time
                                </th>
                                <th>
                                    Source
                                </th>
                                <th>
                                    Destination
                                </th>
                                <th>
                                    Protocol
                                </th>
                                <th>
                                    Length (bytes)
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="pagination justify-content-center" id="demo">
            </div>

            <nav aria-label="...">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                    </li>
                    <li class="page-item active">
                        <a class="page-link" href="#">1</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">2 <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">3</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">Next</a>
                    </li>
                </ul>
            </nav>

        </div>
    </div>
{% endblock %}

{% block script %}
    <script type="application/javascript" src="{% static 'js/plugins/simplePagination.js' %}"></script>
    <!--suppress JSUnfilteredForInLoop, JSUnresolvedVariable -->
    <script type="application/javascript">
        $(function() {
            const jobId = urlParams.get('job_id');
            const $sniffedPktsTable = $('#sniffed-pkts-table');
            const $playCaptureBtn = $('#play-capture-btn');
            const $pauseCaptureBtn = $('#pause-capture-btn');
            const $stopCaptureBtn = $('#stop-capture-btn');
            const $pagination = $('#demo');

            // Pagination
            $pagination.pagination({
                dataSource: [],
                pageNumber: 1,
                items: 0,
                pages: 1,
                currentPage: 1,
                itemsOnPage: 10,
                cssStyle: 'dark-theme'
            });

            const updatePkts = function(sleep=5000, loop=false) {
                window.setTimeout(function() {
                    console.log('updatePkts');
                    if (loop && $pauseCaptureBtn.hasClass('disabled')) {
                        return;
                    }
                    request('POST', '/sniffing/capture', {
                        'job_id': jobId,
                        'page':  $pagination.pagination('getCurrentPage'),
                        'page_size': 10
                    }, function(data, textStatus, jqXHR) {
                        console.log('Sniffing request success!');
                        if (data.job.status === 'SIGSTOP') {
                            // Process stopped
                            $pauseCaptureBtn.addClass('disabled').hide();
                            $playCaptureBtn.removeClass('disabled').show();
                        }
                        $sniffedPktsTable.find('tbody').html('');
                        for (let key in data.result) {
                            let pkt = data.result[key];
                            $sniffedPktsTable.insertTableRow([
                                {name: pkt.number},                   // No.
                                {name: pkt.frame_info.time_relative}, // Time
                                {
                                    name: pkt.source,                 // Source
                                    title: pkt.source_host
                                },
                                {
                                    name: pkt.destination,            // Destination
                                    title: pkt.destination_host
                                },
                                {name: pkt.protocol},                 // Protocol
                                {name: pkt.frame_info.len},           // Length (bytes)
                            ]);
                        }

                        // Pagination
                        $pagination.pagination({
                            dataSource: Object.values(data.result),
                            pageNumber: data.page,
                            items: data.total,
                            pages: data.page_end,
                            currentPage: $pagination.pagination('getCurrentPage'),
                            itemsOnPage: 10,
                            onPageClick: function(pageNumber, event) {
                                console.log('onPageClick');
                                console.log(pageNumber);
                                updatePkts(0, false);
                            }
                        });

                        if (loop) {
                            updatePkts(3000, loop);
                        }
                    }, function(jqXHR, textStatus, errorThrown) {
                        console.error('Sniffing request error!');
                        window.location.replace("/sniffing");
                        {#$stopCaptureBtn.addClass('disabled');#}
                        {#$pauseCaptureBtn.addClass('disabled');#}
                        {#$playCaptureBtn.addClass('disabled');#}
                    });
                }, sleep);
            };
            const signPkts = function(signal, callback) {
                request('POST', '/sniffing/capture', {
                    'job_id': jobId,
                    'signal': signal
                }, function(data, textStatus, jqXHR) {
                    callback(data, textStatus, jqXHR);
                }, function(jqXHR, textStatus, errorThrown) {
                    console.error('Sniffing requests error!');
                    window.location.replace("/sniffing");
                });
            };
            const stopPkts = function() {
                if (confirm("This action will delete the current job permanently! Are you sure ?")) {
                    // 9 = SIGKILL
                    signPkts(9, function(data, textStatus, jqXHR) {
                        console.log('Sniffing requests stopped!');
                        window.location.replace("/sniffing");
                        {#$stopCaptureBtn.addClass('disabled');#}
                        {#$pauseCaptureBtn.addClass('disabled');#}
                        {#$playCaptureBtn.addClass('disabled');#}
                    });
                }
            };
            $stopCaptureBtn.click(stopPkts);
            const pausePkts = function() {
                // 19 = SIGSTOP
                signPkts(19, function(data, textStatus, jqXHR) {
                    console.log('Sniffing requests paused!');
                    $pauseCaptureBtn.addClass('disabled').hide();
                    $playCaptureBtn.removeClass('disabled').show();
                });

            };
            $pauseCaptureBtn.click(pausePkts);
            const playPkts = function() {
                // 18 = SIGCONT
                signPkts(18, function(data, textStatus, jqXHR) {
                    console.log('Sniffing requests played!');
                    $playCaptureBtn.addClass('disabled').hide();
                    $pauseCaptureBtn.removeClass('disabled').show();
                    updatePkts(5000, true);
                });
            };
            $playCaptureBtn.click(playPkts);
            updatePkts(300, true);
        });
    </script>
{% endblock %}
