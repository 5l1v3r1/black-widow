{% extends 'layout/job.html' %}
{% comment %}
    <!--
    *********************************************************************************
    *                                                                               *
    * parse.html -- HTML file.                                                      *
    *                                                                               *
    ************ IMPORTANT MATERIAL DASHBOARD DARK EDITION LICENSE TERMS ************
    *                                                                               *
    * =========================================================                     *
    * Material Dashboard Dark Edition - v2.1.0                                      *
    * =========================================================                     *
    *                                                                               *
    * Product Page: https://www.creative-tim.com/product/material-dashboard-dark    *
    * Copyright 2019 Creative Tim (http://www.creative-tim.com)                     *
    *                                                                               *
    * Coded by www.creative-tim.com                                                 *
    *                                                                               *
    * =========================================================                     *
    *                                                                               *
    * The above copyright notice and this permission notice shall be included in    *
    * all copies or substantial portions of the Software.                           *
    *                                                                               *
    ********************** IMPORTANT BLACK-WIDOW LICENSE TERMS **********************
    *                                                                               *
    * This file is part of black-widow.                                             *
    *                                                                               *
    * black-widow is free software: you can redistribute it and/or modify           *
    * it under the terms of the GNU General Public License as published by          *
    * the Free Software Foundation, either version 3 of the License, or             *
    * (at your option) any later version.                                           *
    *                                                                               *
    * black-widow is distributed in the hope that it will be useful,                *
    * but WITHOUT ANY WARRANTY; without even the implied warranty of                *
    * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                 *
    * GNU General Public License for more details.                                  *
    *                                                                               *
    * You should have received a copy of the GNU General Public License             *
    * along with black-widow.  If not, see <http://www.gnu.org/licenses/>.          *
    *                                                                               *
    *********************************************************************************
    -->
{% endcomment %}
{% load static %}

{% block style %}
    <link href="{% static 'css/plugins/simplePagination.css' %}" rel="stylesheet" />
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a class="parent" href="/web/parsing">Web Parsing</a></li>
        <li class="breadcrumb-item active" aria-current="page">Parse</li>
    </ol>
{% endblock %}

{% block modal-body %}
    <!-- Tag Tree -->
    <div class="section tree">
        <h2>Tags</h2>
        <div class="tree-container">
            <ul class="first-ul" id="tag-tree" depth="{{ job.depth }}">
            </ul>
        </div>
    </div>

    <!-- Separator -->
    <div class="separator row">
        <h2>Forms (TODO: Make a card foreach form)</h2>
        <!-- TODO: Make a card foreach form -->
        <div>
            <h4 style="width: 100%;">https://example.com/submit</h4>
            <form>
                <label>
                    Example 1
                    <input name="example-1" type="text" required="">
                </label>
                <label>
                    Example 2
                    <input name="example-2" type="text">
                </label>
                <label>
                    Example 3
                    <input name="example-3" type="password">
                </label>
                <label>
                    Example 4
                    <input name="example-4" type="checkbox">
                </label>
            </form>
        </div>
    </div>

    <div class="section tag-count">
        <h2>Tag Count</h2>
        <div id="tag-count">
        <button type="button" class="btn btn-danger">
            form <span class="badge badge-light">4</span>
        </button>
        </div>
    </div>
{% endblock %}

{% block card_header %}
    <h4 class="card-title mt-0">Web Parsing</h4>
    <div class="card-category card-info">
        <div class="card-category-label">URL:</div>
        <span class="card-category-content"><a href="{{ job.url }}" target="_blank">{{ job.url }}</a></span>
    </div>
    <div class="card-category card-info">
        <div class="card-category-label">Tags:</div>
        <span class="card-category-content">{{ job.parsing_tags }}</span>
    </div>
{% endblock %}


{% block table %}
    <table class="table table-hover table-select">
        <thead>
        <tr>
            <th>URL</th>
            <th>Results</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
{% endblock %}

{% block script %}
    {{ block.super }}
    <!--suppress JSUnfilteredForInLoop -->
    <script type="application/javascript">
        const $jobModal = $('#job-modal');
        const $dataTable = $('#data-table').find('table').first();
        const $tagTree = $('#tag-tree');
        const $tagCount = $('#tag-count');
        const depth = parseInt($tagTree.attr('depth'));
        let tagDict = {};

        const showJobData = function(result) {
            for (let key in result) {
                // noinspection JSUnfilteredForInLoop
                let page = result[key];
                let count = Object.entries(page).length - 1;
                $dataTable.insertTableRow([
                    {name: page.url},                     // URL
                    {name: count},                        // Results
                ], function() {
                    showPage(page);
                });
                if (depth === 0) {
                    showPage(page);
                }
            }
        };

        /**
         * Show the parsed page in a modal
         * @param page The page Object
         */
        const showPage = function(page) {
            const anchor = '<a target="_black" href="' + page.url+'">' + page.url + '</a>';
            $jobModal.find('.modal-title').html(anchor);
            $tagTree.html('');
            tagDict = {};
            for (let key in page) {
                if (key === 'url') {
                    continue;
                }
                nestTag($tagTree, page[key]);
            }
            tagCountBadge();
            initTree();
            $jobModal.modal();
        };

        /**
         * Creates a badge button foreach tag in tagDict
         */
        const tagCountBadge = function() {
            const htmlBadgeStart='<button type="button" class="btn btn-danger">';
            const htmlBadgeEnd='</button>';
            $tagCount.html('');
            for (let tagName in tagDict) {
                let htmlBadge = htmlBadgeStart;
                htmlBadge += tagName;
                htmlBadge += '<span class="badge badge-light">';
                htmlBadge += tagDict[tagName];
                htmlBadge += '</span>';
                $tagCount.append(htmlBadge);
            }
        }

        /**
         * Append a tag on $parent element and fill tagDict
         * @param page The parent HTML jQuery object
         */
        const nestTag = function ($parent, tag) {
            // TODO: Manage form
            if (Array.isArray(tag)) {
                for (let key in tag) {
                    nestTag($parent, tag[key]);
                }
                return;
            }
            if (tagDict[tag.tag] !== undefined) {
                tagDict[tag.tag]++;
            } else {
                tagDict[tag.tag] = 1;
            }
            let attrsLength;
            if (tag.attrs) {
                attrsLength = Object.entries(tag.attrs).length;
            } else {
                attrsLength = 0;
            }
            let html = '<li>';
            if (tag.children || attrsLength > 0) {
                html += '<span class="caret"></span>';
            }
            const tagName = tag.name && tag.name !== tag.tag ? ('&nbsp; <code>#' + tag.name+'</code>') : '';
            html += '&lt;'+tag.tag+tagName;
            if (attrsLength === 0) {
                html += '&gt;'
            }
            html += '</li>';
            const $me = $(html).appendTo($parent);
            let childParentHtml = '<ul class="nested"></ul>';
            const $childParent = $(childParentHtml).appendTo($me);
            if (attrsLength > 0) {
                for (let key in tag.attrs) {
                    let value = tag.attrs[key];
                    if (!value) {
                        continue;
                    }
                    let attrHtml = '<li><span class="tag-key">'+key+'</span>=';
                    attrHtml += '<span class="tag-value">"'+value+'"</span></li>';
                    $childParent.append(attrHtml);
                }
                $childParent.append('<span class="close-tag">&gt;</span>');
            }
            if (tag.data) {
                let attrHtml = '<li><code>'+tag.data+'</code></li>';
                $childParent.append(attrHtml);
            }
            if (tag.tag === 'title') {
                return;
            }
            if (tag.children) {
                for (let key in tag.children) {
                    nestTag($childParent, tag.children[key]);
                    // TODO: remove the following code but debug
                    // https://google-gruyere.appspot.com/481539122071012622308164458170409025612/editprofile.gtl
                    // with "All Tags"
                    if (tag.tag === 'title') {
                        return;
                    }
                }
            }
            if (tag.data || attrsLength > 0 || tag.children) {
                let ltHtml = '<span class="nested nested-tag caret">';
                ltHtml += '&lt;/'+ tag.tag +'&gt;';
                ltHtml += '</span>';
                $me.append(ltHtml);
            }
        }
    </script>
{% endblock %}
