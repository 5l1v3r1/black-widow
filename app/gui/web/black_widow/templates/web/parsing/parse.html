{% extends 'layout/job.html' %}
{% comment %}
    <!--
    *********************************************************************************
    *                                                                               *
    * parse.html -- HTML file.                                                      *
    *                                                                               *
    ************ IMPORTANT MATERIAL DASHBOARD DARK EDITION LICENSE TERMS ************
    *                                                                               *
    * =========================================================                     *
    * Material Dashboard Dark Edition - v2.1.0                                      *
    * =========================================================                     *
    *                                                                               *
    * Product Page: https://www.creative-tim.com/product/material-dashboard-dark    *
    * Copyright 2019 Creative Tim (http://www.creative-tim.com)                     *
    *                                                                               *
    * Coded by www.creative-tim.com                                                 *
    *                                                                               *
    * =========================================================                     *
    *                                                                               *
    * The above copyright notice and this permission notice shall be included in    *
    * all copies or substantial portions of the Software.                           *
    *                                                                               *
    ********************** IMPORTANT BLACK-WIDOW LICENSE TERMS **********************
    *                                                                               *
    * This file is part of black-widow.                                             *
    *                                                                               *
    * black-widow is free software: you can redistribute it and/or modify           *
    * it under the terms of the GNU General Public License as published by          *
    * the Free Software Foundation, either version 3 of the License, or             *
    * (at your option) any later version.                                           *
    *                                                                               *
    * black-widow is distributed in the hope that it will be useful,                *
    * but WITHOUT ANY WARRANTY; without even the implied warranty of                *
    * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                 *
    * GNU General Public License for more details.                                  *
    *                                                                               *
    * You should have received a copy of the GNU General Public License             *
    * along with black-widow.  If not, see <http://www.gnu.org/licenses/>.          *
    *                                                                               *
    *********************************************************************************
    -->
{% endcomment %}
{% load static %}

{% block style %}
    <link href="{% static 'css/plugins/simplePagination.css' %}" rel="stylesheet" />
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a class="parent" href="/web/parsing">Web Parsing</a></li>
        <li class="breadcrumb-item active" aria-current="page">Parse</li>
    </ol>
{% endblock %}

{% block modal-body %}
    <!-- Tag Tree -->
    <div class="section tree">
        <h2>Tags</h2>
        <div class="tree-container">
            <ul class="first-ul" id="tag-tree" depth="{{ job.depth }}">
            </ul>
        </div>
    </div>

    <!-- Separator -->
    <div class="separator row tag-cards">
        <h2 id="tag-cards-title">Forms</h2>

        <div class="col-12 col-md-6 tag-card" id="tag-card-example">
            <div class="card card-light">
                <div class="card-header card-header-danger">
                    <div class="row">
                        <h3 class="col-12 tag-card-title">[method] http://example.com</h3>
                    </div>
                </div>
                <div class="card-body form-container">
                    <form>
                        <div class="form-group">
                            <label class="bmd-label-floating">Email address</label>
                            <input type="email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="bmd-label-floating">Password</label>
                            <input type="password" class="form-control">
                        </div>
                        <div class="form-check">
                            <label class="form-check-label">
                                <input class="form-check-input" type="checkbox" value="">Example 4
                                <span class="form-check-sign"><span class="check"></span></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Example multiple select</label>
                            <select class="form-control">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Example textarea</label>
                            <textarea class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="tag-cards-container" class="row">


        </div>
    </div>

    <div class="section tag-count">
        <h2>Tag Count</h2>
        <div id="tag-count">
        <button type="button" class="btn btn-danger">
            form <span class="badge badge-light">4</span>
        </button>
        </div>
    </div>
{% endblock %}

{% block card_header %}
    <h4 class="card-title mt-0">Web Parsing</h4>
    <div class="card-category card-info">
        <div class="card-category-label">URL:</div>
        <span class="card-category-content"><a href="{{ job.url }}" target="_blank">{{ job.url }}</a></span>
    </div>
    <div class="card-category card-info">
        <div class="card-category-label">Tags:</div>
        <span class="card-category-content">{{ job.parsing_tags }}</span>
    </div>
{% endblock %}


{% block table %}
    <table class="table table-hover table-select">
        <thead>
        <tr>
            <th>URL</th>
            <th>Results</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
{% endblock %}

{% block script %}
    {{ block.super }}
    <!--suppress JSUnfilteredForInLoop -->
    <script type="application/javascript">
        const $jobModal = $('#job-modal');
        const $dataTable = $('#data-table').find('table').first();
        const $tagTree = $('#tag-tree');
        const $tagCount = $('#tag-count');
        const $tagCardExample = $('#tag-card-example');
        const $formCardsContainer = $('#tag-cards-container');
        const depth = parseInt($tagTree.attr('depth'));
        let tagDict = {};

        const showJobData = function(result) {
            for (let key in result) {
                // noinspection JSUnfilteredForInLoop
                let page = result[key];
                let count = Object.entries(page).length - 1;
                $dataTable.insertTableRow([
                    {name: page.url},                     // URL
                    {name: count},                        // Results
                ], function() {
                    showPage(page);
                });
                if (depth === 0) {
                    showPage(page);
                }
            }
        };

        /**
         * Show the parsed page in a modal
         * @param page The page Object
         */
        const showPage = function(page) {
            const anchor = '<a target="_black" href="' + page.url+'">' + page.url + '</a>';
            $jobModal.find('.modal-title').html(anchor);
            $tagTree.html('');
            $formCardsContainer.html('');
            tagDict = {};
            for (let key in page) {
                if (key === 'url') {
                    continue;
                }
                nestTag($tagTree, page[key]);
            }
            tagCountBadge();
            initTree();
            console.log(tagDict);
            $jobModal.modal();
        };

        /**
         * Creates a badge button foreach tag in tagDict
         */
        const tagCountBadge = function() {
            const htmlBadgeStart='<button type="button" class="btn btn-danger">';
            const htmlBadgeEnd='</button>';
            $tagCount.html('');
            for (let tagName in tagDict) {
                let htmlBadge = htmlBadgeStart;
                htmlBadge += tagName;
                htmlBadge += '<span class="badge badge-light">';
                htmlBadge += tagDict[tagName];
                htmlBadge += '</span>';
                htmlBadge += htmlBadgeEnd;
                $tagCount.append(htmlBadge);
            }
        };

        /**
         * Append a tag on $parent element and fill tagDict
         * @param $parent The parent HTML jQuery object
         * @param tag The parsed tag
         */
        const nestTag = function ($parent, tag) {
            if (Array.isArray(tag)) {
                for (let key in tag) {
                    nestTag($parent, tag[key]);
                }
                return;
            }
            if (tag.tag.toLowerCase() === 'form') {
                makeFormCard(tag);
            }
            if (tagDict[tag.tag] !== undefined) {
                tagDict[tag.tag]++;
            } else {
                tagDict[tag.tag] = 1;
            }
            let attrsLength;
            if (tag.attrs) {
                attrsLength = Object.entries(tag.attrs).length;
            } else {
                attrsLength = 0;
            }
            let html = '<li>';
            if (tag.children || attrsLength > 0 || tag.data) {
                html += '<span class="caret"></span>';
            }
            const tagName = tag.name && tag.name !== tag.tag ? ('&nbsp; <code>#' + tag.name+'</code>') : '';
            html += '&lt;'+tag.tag+tagName;
            if (attrsLength === 0) {
                html += '&gt;'
            }
            html += '</li>';
            const $me = $(html).appendTo($parent);
            let childParentHtml = '<ul class="nested"></ul>';
            const $childParent = $(childParentHtml).appendTo($me);
            if (attrsLength > 0) {
                for (let key in tag.attrs) {
                    let value = tag.attrs[key];
                    if (!value) {
                        continue;
                    }
                    let attrHtml = '<li><span class="tag-key">'+key+'</span>=';
                    attrHtml += '<span class="tag-value">"'+value+'"</span></li>';
                    $childParent.append(attrHtml);
                }
                $childParent.append('<span class="close-tag">&gt;</span>');
            }

            if (tag.data) {
                let attrHtml = '<li><code>'+tag.data+'</code></li>';
                $childParent.append(attrHtml);
            }
            if (tag.children) {
                for (let key in tag.children) {
                    nestTag($childParent, tag.children[key]);
                }
            }
            let ltHtml = '<span class="nested nested-tag caret">';
            ltHtml += '&lt;/'+ tag.tag +'&gt;';
            ltHtml += '</span>';
            $me.append(ltHtml);
        };

        /**
         *
         * @param formTag A form tag Object
         */
        const makeFormCard = function (formTag) {
            const $formCardHtml = $tagCardExample.clone();
            const $form = $formCardHtml.find('form');

            $form.html('');
            $formCardHtml.attr('id', null);
            $formCardHtml.find('.tag-card-title').html(
                '<span>[' + formTag.attrs.method.toUpperCase() + '] </span>' +
                '<a href="'+formTag.attrs.action+'" target="_black">' +
                    formTag.attrs.action +
                '</a>'
            );

            for (let key in formTag.attrs) {
                const keyLower = key.toLowerCase();
                if (keyLower === 'id') {
                    continue;
                }
                const value = formTag.attrs[key];
                $form.attr(key, value);
            }

            $formCardHtml.appendTo($formCardsContainer);
            makeFormInput(formTag, $form);
        };

        const makeFormInput = function (formInputTag, $parent) {
            console.log(formInputTag);
            let html = null;
            switch (formInputTag.tag.toLowerCase()) {
                case 'textarea':
                    html = makeTextarea(formInputTag);
                    break;
                case 'select':
                    html = makeSelect(formInputTag);
                    break;
                case 'button':
                    html = makeButton(formInputTag);
                    break;
                case 'input':
                    switch (formInputTag.attrs.type.toLowerCase()) {
                        case 'text':
                        case 'password':
                        case 'email':
                        case 'hidden':
                            html = makeInputText(formInputTag);
                            break;
                        case 'button':
                            html = makeInputButton(formInputTag);
                            break;
                        case 'checkbox':
                            html = makeInputCheckbox(formInputTag);
                            break;
                        default:
                            console.error('Unsupported input ' + formInputTag.attrs.type);
                            break;
                    }
                    break;
                default:
                    if (formInputTag.children) {
                        for (let key in formInputTag.children) {
                            makeFormInput(formInputTag.children[key], $parent);
                        }
                    }
                    break;
            }
            if (html !== null) {
                $parent.append(html);
            }
        };

        const attrsToHtml = function (attrs) {
            let html = '';
            for (let key in attrs) {
                const keyLower = key.toLowerCase();
                if (keyLower === 'id') {
                    continue;
                }
                let value = attrs[key];
                if (keyLower === 'type' && value === 'hidden') {
                    value = 'text';
                }
                html += ' ' + key + '="' + value + '"';
            }
            return html;
        };

        /**
         * Make an HTML Input Text
         * @param textTag Object
         * @returns {string}
         */
        const makeInputText = function (textTag) {
            let html = '<div class="form-group">';
            html += '<label>'+textTag.attrs.name+'</label>';
            html += '<input class="form-control"';
            html += attrsToHtml(textTag.attrs);
            html += '>';
            html += '</div>';
            return html;
        };

        /**
         * Make an HTML Input Checkbox
         * @param checkboxTag Object
         * @returns {string}
         */
        const makeInputCheckbox = function (checkboxTag) {
            let html = '<div class="form-check form-group">';
            html += '<label class="form-check-label">';
            html += '<input class="form-check-input" type="checkbox"';
            html +=  ' value="' + checkboxTag.attrs.name + '">';
            html += checkboxTag.attrs.name;
            html += '<span class="form-check-sign"><span class="check"></span></span>';
            html += '</label>';
            html += '</div>';
            return html;
        };

        /**
         * Make an HTML Input Button
         * @param buttonTag Object
         * @returns {string}
         */
        const makeInputButton = function (buttonTag) {
            console.log('making input button', buttonTag);
            let html = '<input class="btn btn-danger"';
            html += attrsToHtml(buttonTag.attrs);
            html += '>';
            return html;
        };

        /**
         * Make an HTML Select
         * @param selectTag Object
         * @returns {string}
         */
        const makeSelect = function (selectTag) {
            console.log('making select', selectTag);
            let html = '<div class="form-group">';
            html += '<label>'+selectTag.attrs.name+'</label>';
            // TODO: Make options
            html += '</div>';
            return html;
        };

        /**
         * Make an HTML Textarea
         * @param textareaTag Object
         * @returns {string}
         */
        const makeTextarea = function (textareaTag) {
            console.log('making textarea', textareaTag);
            let html = '<div class="form-group">';
            html += '<label>'+textareaTag.attrs.name+'</label>';
            html += '<textarea class="form-control" rows="5">'+textareaTag.attrs.data+'</textarea>';
            html += '</div>';
            return html;
        };

        /**
         * Make an HTML Button
         * @param buttonTag Object
         * @returns {string}
         */
        const makeButton = function (buttonTag) {
            let html = '<button class="btn btn-danger"';
            html += attrsToHtml(buttonTag.attrs);
            html += '>';
            if (buttonTag.data) {
                html += buttonTag.data;
            } else if (buttonTag.attrs.value) {
                html += buttonTag.attrs.value;
            } else if (buttonTag.attrs.type) {
                html += buttonTag.attrs.type;
            } else {
                html += 'Button';
            }
            html += '</button>';
            return html;
        };
    </script>
{% endblock %}
